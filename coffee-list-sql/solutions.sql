-- QUESTION 1
-- Question 1.1.
-- Create Database
CREATE DATABASE COFFEELIST;
USE COFFEELIST;

-- TABLE: COFFEE
CREATE TABLE COFFEE
(
    COFFEE_CODE VARCHAR(5) NOT NULL PRIMARY KEY,
    COFFEE_NAME VARCHAR(40) NOT NULL,
    COFFEE_BRAND VARCHAR(40) NOT NULL,
    STRENGTH SMALLINT NOT NULL,   -- corrected to numeric
    PRICE SMALLMONEY NOT NULL
);

-- TABLE: STORES
CREATE TABLE STORES
(
    STORE_CODE VARCHAR(5) NOT NULL PRIMARY KEY,
    STORE_NAME VARCHAR(20) NOT NULL,
    ADDRESS VARCHAR(50) NOT NULL,
    CITY VARCHAR(20) NOT NULL
);

-- TABLE: AVAILABILITY
CREATE TABLE AVAILABILITY
(
    COFFEE_CODE VARCHAR(5) NOT NULL,
    STORE_CODE VARCHAR(5) NOT NULL,
    AVAILABLE_STOCK SMALLINT NOT NULL,

    -- Constraints
    PRIMARY KEY (COFFEE_CODE, STORE_CODE),
    FOREIGN KEY (COFFEE_CODE) REFERENCES COFFEE(COFFEE_CODE),
    FOREIGN KEY (STORE_CODE) REFERENCES STORES(STORE_CODE)
);

-- Question 1.2.
-- Populate Table: COFFEE
INSERT INTO COFFEE (COFFEE_CODE, COFFEE_NAME, COFFEE_BRAND, STRENGTH, PRICE)
VALUES
    ('C001', 'San Remo', 'Roastmasters', 9, 350),
    ('C002', 'Sweet Italian Blend', 'Mastertons', 5, 230),
    ('C003', 'The Great Dane', 'Terbodore', 8, 365),
    ('C004', 'Black Honey', 'Truth Coffee', 6, 117),
    ('C005', 'Pure Arabica', 'Hazz Coffee', 7, 95);

-- Populate Table: STORES
INSERT INTO STORES (STORE_CODE, STORE_NAME, ADDRESS, CITY)
VALUES
    ('ST001', 'Local Grind', '167 Pert Road', 'Johannesburg'),
    ('ST002', 'Club Coffee', '5 Second Avenue', 'Gqeberha'),
    ('ST003', 'Boston Barista', '33 Bertha Mkhize Street', 'Durban'),
    ('ST004', 'Jacked Up Coffee', '27 Bram Fischer Road', 'Durban'),
    ('ST005', 'Impresso Espresso', '210 Du Toit Street', 'Tshwane');

-- Populate Table: AVAILABILITY
INSERT INTO AVAILABILITY (COFFEE_CODE, STORE_CODE, AVAILABLE_STOCK)
VALUES
    ('C002', 'ST001', 13),
    ('C002', 'ST004', 9),
    ('C003', 'ST005', 8),
    ('C004', 'ST003', 5),
    ('C004', 'ST001', 9);

-- Question 1.3.
ALTER TABLE AVAILABILITY
ADD STOCK_ORDERED SMALLINT DEFAULT 0;

-- Question 1.4.
UPDATE AVAILABILITY
SET STOCK_ORDERED = 3
WHERE COFFEE_CODE = 'C004' AND STORE_CODE = 'ST003';

-- QUESTION 2
-- Question 2.1.
-- Coffees not available in any store
SELECT COFFEE_NAME, COFFEE_BRAND
FROM COFFEE
WHERE COFFEE_CODE NOT IN (SELECT COFFEE_CODE FROM AVAILABILITY);

-- Question 2.2.
-- Total available stock per coffee
SELECT
    COFFEE.COFFEE_NAME,
    COFFEE.COFFEE_BRAND AS BRAND,
    SUM(AVAILABILITY.AVAILABLE_STOCK) AS TOTAL_AVAILABLE
FROM
    COFFEE
LEFT JOIN
    AVAILABILITY ON COFFEE.COFFEE_CODE = AVAILABILITY.COFFEE_CODE
GROUP BY
    COFFEE.COFFEE_NAME, COFFEE.COFFEE_BRAND
ORDER BY
    COFFEE.COFFEE_NAME ASC;

-- Question 2.3.
-- Store with most stock of coffee C002
SELECT TOP 1
    STORES.STORE_NAME,
    STORES.ADDRESS,
    STORES.CITY,
    COFFEE.COFFEE_NAME,
    COFFEE.COFFEE_BRAND,
    AVAILABILITY.AVAILABLE_STOCK
FROM
    AVAILABILITY
JOIN COFFEE ON COFFEE.COFFEE_CODE = AVAILABILITY.COFFEE_CODE
JOIN STORES ON STORES.STORE_CODE = AVAILABILITY.STORE_CODE
WHERE
    AVAILABILITY.COFFEE_CODE = 'C002'
ORDER BY
    AVAILABILITY.AVAILABLE_STOCK DESC;
